<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hostel Attendance – Firebase Cloud</title>
<style>
body{font-family:Arial;background:#f2f2f2;padding:8px}
.box{max-width:600px;margin:auto;background:#fff;padding:12px;border-radius:8px;margin-bottom:10px}
input{padding:6px;margin:4px 0;font-size:14px;width:220px;max-width:100%;box-sizing:border-box}
button{padding:6px 10px;margin:4px 0;font-size:13px;background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}
button.small{padding:3px 6px;font-size:11px}
button.red{background:#dc3545}
button.gray{background:#6c757d}
.student{display:flex;justify-content:space-between;align-items:center;padding:6px;background:#eee;margin:4px 0;border-radius:5px;font-size:14px}
.present{background:#c8f7c5}
.hidden{display:none}
.inline{display:flex;gap:6px;flex-wrap:wrap}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <h3>Login</h3>
  <div class="inline">
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
  </div>
  <button id="loginBtn">Login</button>
</div>

<!-- MAIN -->
<div class="box hidden" id="mainBox">
  <h3>Hostel Attendance</h3>
  
  <label>Date</label><br>
  <input type="date" id="date"><br>

  <button class="gray" id="toggleAddSectionBtn">Add Student</button>
  <div id="addSection" class="hidden">
    <div class="inline">
      <input id="studentName" placeholder="Student Name">
      <input id="roomNo" placeholder="Room No">
    </div>
    <button id="addBtn">Add</button>
    <button class="gray small" id="toggleStudentsBtn">Show Students</button>
    <div id="studentsBlock" class="hidden">
      <h4>Students Added</h4>
      <div id="studentList"></div>
    </div>
  </div>

  <h4>Today's Attendance</h4>
  <input id="searchBox" placeholder="Search name">
  <div id="attendanceList"></div>
  <p><b>Total Present:</b> <span id="total">0</span></p>
  <button id="showAbsentBtn" class="gray">Show Absent</button>
  <div id="absentList" class="hidden"></div>

  <button id="exportDailyBtn">Export Present (Excel)</button>
  <hr>
  <button id="toggleMonthlyBtn" class="gray">Monthly Report</button>
  <div id="monthlySection" class="hidden">
    <input type="month" id="monthPicker">
    <button id="generateReportBtn">Load</button>
    <button id="exportMonthlyBtn" class="gray hidden">Export Monthly</button>
    <div id="monthlyReport"></div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB6r-_Gh7oetNvTGayPLXbkKYqSyiQv204",
  authDomain: "hostelattendance-c912f.firebaseapp.com",
  databaseURL: "https://hostelattendance-c912f-default-rtdb.firebaseio.com",
  projectId: "hostelattendance-c912f",
  storageBucket: "hostelattendance-c912f.firebasestorage.app",
  messagingSenderId: "39772036836",
  appId: "1:39772036836:web:fef0ab68acb8b2fd6056f1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Elements
const loginBox = document.getElementById('loginBox');
const mainBox = document.getElementById('mainBox');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const dateInput = document.getElementById('date');
const studentName = document.getElementById('studentName');
const roomNo = document.getElementById('roomNo');
const addBtn = document.getElementById('addBtn');
const studentList = document.getElementById('studentList');
const attendanceList = document.getElementById('attendanceList');
const searchBox = document.getElementById('searchBox');
const totalSpan = document.getElementById('total');
const absentList = document.getElementById('absentList');
const exportDailyBtn = document.getElementById('exportDailyBtn');
const toggleAddSectionBtn = document.getElementById('toggleAddSectionBtn');
const toggleStudentsBtn = document.getElementById('toggleStudentsBtn');
const showAbsentBtn = document.getElementById('showAbsentBtn');
const toggleMonthlyBtn = document.getElementById('toggleMonthlyBtn');
const monthlySection = document.getElementById('monthlySection');
const monthPicker = document.getElementById('monthPicker');
const generateReportBtn = document.getElementById('generateReportBtn');
const monthlyReport = document.getElementById('monthlyReport');
const exportMonthlyBtn = document.getElementById('exportMonthlyBtn');

let students = {};
let attendance = {};
let role = '';

dateInput.valueAsDate = new Date();

// Login
document.getElementById('loginBtn').addEventListener('click', ()=> {
  const usernameVal = usernameInput.value.trim();
  const passwordVal = passwordInput.value.trim();
  if(usernameVal==='admin' && passwordVal==='1234') role='admin';
  else if(usernameVal==='hostel' && passwordVal==='1234') role='staff';
  else return alert('Invalid login');
  loginBox.classList.add('hidden');
  mainBox.classList.remove('hidden');
  if(role==='staff') addSection.classList.add('hidden');
  render();
});

// Add Student
addBtn.onclick = () => {
  if(role!=='admin' && role!=='staff') return alert('No permission');
  if(!studentName.value||!roomNo.value) return alert('Enter details');
  db.ref('students').push({name:studentName.value,room:roomNo.value});
  studentName.value=''; roomNo.value='';
};

// Fetch Data
db.ref('students').on('value', s => { students = s.val()||{}; render(); });
db.ref('attendance').on('value', s => { attendance = s.val()||{}; render(); });

// Toggle Attendance
function toggleAttendance(name){
  const d = dateInput.value;
  if(!attendance[d]) attendance[d] = [];
  const i = attendance[d].indexOf(name);
  i===-1 ? attendance[d].push(name) : attendance[d].splice(i,1);
  db.ref('attendance/'+d).set(attendance[d]);
}

// Render
function render(){
  studentList.innerHTML=''; attendanceList.innerHTML=''; absentList.innerHTML='';
  let c=0, d=dateInput.value, q=searchBox.value.toLowerCase();
  Object.entries(students).forEach(([k,s])=>{
    // Student list
    const row=document.createElement('div'); row.className='student';
    row.innerHTML=`<span>${s.name} (${s.room})</span>${(role==='admin'||role==='staff')?'<button class="red small">X</button>':''}`;
    row.querySelector('button')?.addEventListener('click', ()=> db.ref('students/'+k).remove());
    studentList.appendChild(row);

    const p = attendance[d]?.includes(s.name);
    if(!q || s.name.toLowerCase().includes(q)){
      const a=document.createElement('div'); a.className='student'+(p?' present':'');
      a.onclick = ()=> toggleAttendance(s.name);
      a.innerHTML = `<span>${s.name} (${s.room})</span><span>${p?'✔':''}</span>`;
      attendanceList.appendChild(a);
    }
    if(p) c++;
  });
  totalSpan.innerText = c;
}

// Show absent
showAbsentBtn.onclick = ()=>{
  absentList.classList.toggle('hidden'); absentList.innerHTML='';
  const d = dateInput.value;
  Object.values(students).forEach(s=>{
    if(!attendance[d]?.includes(s.name)){
      const a=document.createElement('div'); a.className='student';
      a.innerText=`${s.name} (${s.room})`; absentList.appendChild(a);
    }
  });
};

// Export daily
exportDailyBtn.onclick = ()=>{
  let csv='Name,Room\n';
  const d = dateInput.value;
  Object.values(students).forEach(s=>{
    if(attendance[d]?.includes(s.name)) csv+=`${s.name},${s.room}\n`;
  });
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='Present_'+d+'.csv'; a.click();
};

// Monthly report toggle
toggleMonthlyBtn.onclick = ()=> monthlySection.classList.toggle('hidden');

// Generate monthly report
generateReportBtn.onclick = ()=>{
  if(role!=='admin' && role!=='staff') return alert('No permission');
  monthlyReport.innerHTML=''; exportMonthlyBtn.classList.remove('hidden');
  const m = monthPicker.value;
  Object.keys(attendance).filter(d=>d.startsWith(m)).forEach(d=>{
    const p = attendance[d].length;
    const t = Object.keys(students).length;
    const div = document.createElement('div'); div.className='student';
    div.innerHTML = `${d} → Present:${p} Absent:${t-p} <button class="red small">Delete</button>`;
    div.querySelector('button').onclick = ()=> db.ref('attendance/'+d).remove();
    monthlyReport.appendChild(div);
  });
};

// Export monthly
exportMonthlyBtn.onclick = ()=>{
  const m = monthPicker.value;
  let csv='Date,Present,Absent\n';
  Object.keys(attendance).filter(d=>d.startsWith(m)).forEach(d=>{
    const p = attendance[d].length;
    csv += `${d},${p},${Object.keys(students).length-p}\n`;
  });
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='Monthly_Report_'+m+'.csv'; a.click();
};

// Event listeners
searchBox.oninput = render;
dateInput.onchange = render;
toggleAddSectionBtn.onclick = ()=> addSection.classList.toggle('hidden');
toggleStudentsBtn.onclick = ()=> studentsBlock.classList.toggle('hidden');
</script>
</body>
</html>
