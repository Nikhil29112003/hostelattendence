<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hostel Attendance â€“ Firebase Cloud</title>
<style>
body{font-family:Arial;background:#f2f2f2;padding:10px}
.box{max-width:900px;margin:auto;background:#fff;padding:15px;border-radius:8px;margin-bottom:10px}
input,button{padding:10px;margin:6px 0;font-size:15px}
input{width:100%}
button{background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer}
button.small{padding:4px 8px;font-size:12px}
button.red{background:#dc3545}
button.gray{background:#6c757d}
.student{display:flex;justify-content:space-between;align-items:center;padding:8px;background:#eee;margin:4px 0;border-radius:5px}
.present{background:#c8f7c5}
.hidden{display:none}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
<h2>Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
<p>Use: <b>admin / 1234</b></p>
</div>

<!-- MAIN -->
<div class="box hidden" id="mainBox">
<h2>Hostel Attendance (Cloud)</h2>

<label>Date</label>
<input type="date" id="date">

<button class="gray" id="toggleAddSectionBtn">Show / Hide Add Student</button>
<div id="addSection" class="hidden">
<input id="studentName" placeholder="Student Name">
<input id="roomNo" placeholder="Room Number">
<button id="addBtn">Add Student</button>
<button class="gray" id="toggleStudentsBtn">Show / Hide Students Added</button>
<div id="studentsBlock" class="hidden">
<h3>Students Added</h3>
<div id="studentList"></div>
</div>
</div>

<h3>Today's Attendance</h3>
<input id="searchBox" placeholder="Search student name">
<div id="attendanceList"></div>
<p><b>Total Present:</b> <span id="total">0</span></p>
<button id="showAbsentBtn" class="gray">Show Absent Students</button>
<div id="absentList" class="hidden"></div>
<button id="exportDailyBtn">Export Today (Present Only)</button>
</div>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ðŸ”¥ FIREBASE CONFIG (REPLACE WITH YOUR OWN)
const firebaseConfig = {
  apiKey: "AIzaSyB6r-_Gh7oetNvTGayPLXbkKYqSyiQv204",
  authDomain: "hostelattendance-c912f.firebaseapp.com",
  databaseURL: "https://hostelattendance-c912f-default-rtdb.firebaseio.com",
  projectId: "hostelattendance-c912f",
  storageBucket: "hostelattendance-c912f.firebasestorage.app",
  messagingSenderId: "39772036836",
  appId: "1:39772036836:web:fef0ab68acb8b2fd6056f1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== ELEMENTS =====
const loginBox = document.getElementById('loginBox');
const mainBox = document.getElementById('mainBox');
const loginBtn = document.getElementById('loginBtn');
const addBtn = document.getElementById('addBtn');
const toggleStudentsBtn = document.getElementById('toggleStudentsBtn');
const toggleAddSectionBtn = document.getElementById('toggleAddSectionBtn');
const dateInput = document.getElementById('date');
const searchBox = document.getElementById('searchBox');
const studentList = document.getElementById('studentList');
const attendanceList = document.getElementById('attendanceList');
const absentList = document.getElementById('absentList');
const totalSpan = document.getElementById('total');
const showAbsentBtn = document.getElementById('showAbsentBtn');
const addSection = document.getElementById('addSection');

let students = [];
let attendance = {};

dateInput.valueAsDate = new Date();

// ===== LOGIN =====
loginBtn.onclick = ()=>{
  if(username.value==='admin' && password.value==='1234'){
    loginBox.classList.add('hidden');
    mainBox.classList.remove('hidden');
  } else alert('Invalid login');
};

// ===== FIREBASE LISTENERS =====
db.ref('students').on('value',snap=>{
  students = snap.val() ? Object.values(snap.val()) : [];
  render();
});

db.ref('attendance').on('value',snap=>{
  attendance = snap.val() || {};
  render();
});

// ===== ADD STUDENT =====
addBtn.onclick = ()=>{
  const name = studentName.value.trim();
  const room = roomNo.value.trim();
  if(!name||!room) return alert('Enter name & room');
  db.ref('students').push({name,room});
  studentName.value=''; roomNo.value='';
};

// ===== TOGGLES =====
toggleAddSectionBtn.onclick=()=>addSection.classList.toggle('hidden');
toggleStudentsBtn.onclick=()=>studentsBlock.classList.toggle('hidden');

function toggleAttendance(name){
  const d = dateInput.value;
  if(!attendance[d]) attendance[d]=[];
  const arr = attendance[d];
  const i = arr.indexOf(name);
  if(i===-1) arr.push(name); else arr.splice(i,1);
  db.ref('attendance/'+d).set(arr);
}

function render(){
  studentList.innerHTML=''; attendanceList.innerHTML=''; absentList.innerHTML='';
  let c=0; const d=dateInput.value; const q=searchBox.value.toLowerCase();
  students.forEach(s=>{
    const row=document.createElement('div'); row.className='student';
    row.innerHTML=`<span>${s.name} (Room ${s.room})</span>`;
    studentList.appendChild(row);

    const p = attendance[d]?.includes(s.name);
    if(q && s.name.toLowerCase().includes(q)){
      const a=document.createElement('div'); a.className='student'+(p?' present':'');
      a.onclick=()=>toggleAttendance(s.name);
      a.innerHTML=`<span>${s.name} - Room ${s.room}</span><span>${p?'âœ”':''}</span>`;
      attendanceList.appendChild(a);
    }
    if(p) c++;
  }); totalSpan.innerText=c;
}

showAbsentBtn.onclick=()=>{
  absentList.classList.toggle('hidden'); absentList.innerHTML='';
  const d=dateInput.value;
  students.forEach(s=>{
    if(!attendance[d]?.includes(s.name)){
      const ab=document.createElement('div'); ab.className='student';
      ab.innerHTML=`<span>${s.name} - Room ${s.room}</span>`;
      absentList.appendChild(ab);
    }
  });
};

exportDailyBtn.onclick=()=>{
  const d=dateInput.value; let csv='Name,Room\n';
  students.forEach(s=>{ if(attendance[d]?.includes(s.name)) csv+=`${s.name},${s.room}\n`; });
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='Daily_Present_'+d+'.csv'; a.click();
};

searchBox.oninput=render; dateInput.onchange=render;
</script>
</body>
</html>
